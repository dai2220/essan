<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

  <title>ハーベスト履歴表示</title>
</head>
<body>
  <div class="container">
    <div class="card text-dark bg-light mb-3 mt-3">
      <div class="card-header">アカウント残高</div>
      <div class="card-body">
        <h5 class="card-title"><span id="account_amount">0</span> XYM</h5>
      </div>
    </div>
    <table id="harvest" class="table">
      <thead>
        <tr>
          <th scope="col">datetime</th>
          <th scope="col">block</th>
          <th scope="col">Amount</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <dl>
      <dd><a id="harvests_more" href="javascript:void(0)" >さらに読み込む</a></dd>
    </dl>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://xembook.github.io/nem2-browserify/symbol-sdk-1.0.2.js"></script>
  <script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

  <script>
    const node = "https://dual-1.nodes-xym.work:3001";
    const rawAddress = "NDFT3W-A3S6JT-5274N7-6DRT6X-OMRPVE-2RGBT5-2KA";
    const sym = require("/node_modules/symbol-sdk");
    const op = require("/node_modules/rxjs/operators");
    const pageSize = 10;

    const repo = new sym.RepositoryFactoryHttp(node);
    const receiptRepo = repo.createReceiptRepository();
    const blockRepo = repo.createBlockRepository();
    const accountRepo = repo.createAccountRepository();
    const currencyId = "6BED913FA20223F8";
    var epochAdjustment;
    var harvestPageNumber=0;
    var address = sym.Address.createFromRawAddress(rawAddress);



    (async() =>{
      epochAdjustment = await repo.getEpochAdjustment().toPromise();
      getHarvests(pageSize);
      getAmount();
    })();

    $('#harvests_more' ).click(function(){getHarvests(pageSize); return false;});
    
    const getAmount = async () => {
      const accountInfo = accountRepo.getAccountInfo(address)
        accountInfo.pipe(
          op.mergeMap(_=>_.mosaics),
          op.filter(_ => _.id.toHex() === currencyId),
        )
        .subscribe(_=>{
          $('#account_amount').text(dispAmount(_.amount.toString(),6));
        });
    }

    const getHarvests = async(page) => {
      
      harvestPageNumber++;

      const res = await receiptRepo.searchReceipts({
        targetAddress: address,
        order: "desc",
        pageSize: page,
        pageNumber: harvestPageNumber,
        receiptTypes: [sym.ReceiptType.Harvest_Fee],
      })
      .toPromise();
      console.log(res);
      var lastHeight = 0;
      var cnt = 0;
      for(const statements  of res.data){

        const filterdReceipts = statements.receipts.filter(item => {
          if(item.targetAddress){
            return item.targetAddress.plain() === address.plain();
          }
          return false;
        });

        if(statements.height.toString() !== lastHeight.toString()){
          cnt = 0;
        }
        for(const receipt of filterdReceipts){
          showReceiptInfo("harvest",statements.height,receipt,cnt);
          lastHeight = statements.height;
          cnt++;
        }
      }
      console.log(res.isLastPage);
      if(res.isLastPage){
        $('#harvests_more').hide();
      }
      return res.isLastPage;
    }

    const showReceiptInfo = (tag,height,receipt,cnt) => {

      if(cnt === 0){
        cnt = "";
      }
      console.log(height);

      $("#" + tag).append("<tr>"
      + "<td id='" + tag + "_date" + height + receipt.type + cnt + "'></td>"
      + "<td id='" + tag + "_type' style='font-size:84%;' class='text-left'>" + height + "</td>"
      + "<td id='" + tag + "_amount' class='text-right'>" + dispAmount(receipt.amount,6) + "</td>"
      + "</tr>"
      );

      dispBlockTimeStamp("#" + tag + "_date"+ height + receipt.type,height);
    }

    const dispAmount = (amount, divisibility) => {
      var strNum = amount.toString();
      if (divisibility > 0) {
        if (amount < Math.pow(10, divisibility)) {
          return "0." + paddingAmount0(strNum, 0, divisibility);
        } else {
          var r = strNum.slice(-divisibility);
          var l = strNum.substring(0, strNum.length - divisibility);
          return comma3(l) + "." + r;
        }
      } else {
        return comma3(strNum);
      }
    }
    const comma3 = (strNum) => {
      return strNum.replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,");
    }
    
    const paddingAmount0 = (val, char, n) => {
      for (; val.length < n; val = char + val);
      return val;
    }
    
    const dispTimeStamp = (timeStamp, epoch) => {
      var d = dayjs(timeStamp + epoch * 1000);
      return d.format('YYYY-MM-DD HH:mm:ss');
    }

    const dispBlockTimeStamp = (id,height) => {
      blockRepo.getBlockByHeight(height)
      .subscribe(block => {
        $(id).text(
          dispTimeStamp(Number(block.timestamp.toString()),epochAdjustment)
        );
      })
    }
  </script>
</body>
</html>
